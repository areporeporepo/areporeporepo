name: Weather Box

on:
  schedule:
    - cron: "*/15 * * * *" # Every 15 minutes
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Earth Engine API
        run: pip install earthengine-api

      - name: Read Earth-2 Atlas forecast
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          FORECAST_GIST_ID: ${{ secrets.FORECAST_GIST_ID }}
        run: |
          E2_DATA=$(python3 .github/scripts/earth2_forecast.py 2>/dev/null || echo '{}')
          echo "E2_DATA=$E2_DATA" >> $GITHUB_ENV

      - name: Fetch Stanford ground truth
        run: |
          STANFORD_DATA=$(python3 .github/scripts/stanford_weather.py 2>/dev/null || echo '{}')
          echo "STANFORD_DATA=$STANFORD_DATA" >> $GITHUB_ENV

      - name: Fetch NDVI
        env:
          GEE_SERVICE_ACCOUNT_KEY: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
          LAT: "37.44783"
          LON: "-122.13604"
        run: |
          NDVI_DATA=$(python3 .github/scripts/canopy.py 2>/dev/null || echo '{"ndvi":0,"prev_ndvi":0,"date":""}')
          echo "NDVI_DATA=$NDVI_DATA" >> $GITHUB_ENV

      - name: Build weather gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
          TZ: America/Los_Angeles
        run: |
          WEATHER=$(python3 -c "
          import json, math, sys
          from datetime import datetime, timedelta

          atlas = json.loads(sys.argv[1])
          canopy = json.loads(sys.argv[2])
          stanford = json.loads(sys.argv[3])

          icons = {
            0:'â˜€ï¸',1:'ğŸŒ¤',2:'â›…ï¸',3:'â˜ï¸',45:'ğŸŒ«',48:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ¦',55:'ğŸŒ¦',
            61:'ğŸŒ§',63:'ğŸŒ§',65:'ğŸŒ§',71:'ğŸŒ¨',73:'ğŸŒ¨',75:'ğŸŒ¨',80:'ğŸŒ§',81:'ğŸŒ§',82:'ğŸŒ§',
            95:'â›ˆï¸',96:'â›ˆï¸',99:'â›ˆï¸'
          }
          def moon_icon(date_str):
              dt = datetime.strptime(date_str, '%Y-%m-%d') if isinstance(date_str, str) else date_str
              ref = datetime(2000, 1, 6, 18, 14)
              age = ((dt - ref).total_seconds() / 86400) % 29.530588853
              phases = ['ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜']
              return phases[int((age / 29.530588853) * 8) % 8]
          def moon_phase(date_str):
              m = moon_icon(date_str)
              return m if m in ('ğŸŒ‘','ğŸŒ•') else ''

          days_names = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']
          now = datetime.now()

          # --- Sunrise/sunset calculation ---
          def calc_sun(lat, lon, date):
              doy = date.timetuple().tm_yday
              d2r = math.pi / 180
              r2d = 180 / math.pi
              lng_h = lon / 15
              zenith = 90.833
              results = []
              for target_h in [6, 18]:
                  t = doy + (target_h - lng_h) / 24
                  m = 0.9856 * t - 3.289
                  l = (m + 1.916*math.sin(m*d2r) + 0.020*math.sin(2*m*d2r) + 282.634) % 360
                  ra = r2d * math.atan(0.91764 * math.tan(l*d2r))
                  ra = (ra % 360) + ((l//90)*90 - (ra//90)*90)
                  ra /= 15
                  sin_d = 0.39782 * math.sin(l*d2r)
                  cos_d = math.cos(math.asin(sin_d))
                  cos_h = (math.cos(zenith*d2r) - sin_d*math.sin(lat*d2r)) / (cos_d*math.cos(lat*d2r))
                  cos_h = max(-1, min(1, cos_h))
                  if target_h == 6:
                      h_ang = (360 - r2d*math.acos(cos_h)) / 15
                  else:
                      h_ang = r2d*math.acos(cos_h) / 15
                  ut = ((h_ang + ra - 0.06571*t - 6.622) - lng_h) % 24
                  pst = (ut - 8) % 24
                  results.append(f'{date.strftime(\"%Y-%m-%d\")}T{int(pst):02d}:{int((pst%1)*60):02d}')
              return results[0], results[1]

          sunrise_str, sunset_str = calc_sun(37.4478, -122.136, now)
          sunrise_t = sunrise_str.split('T')[-1]
          sunset_t = sunset_str.split('T')[-1]
          sunrise_hour = int(sunrise_t.split(':')[0])
          sunset_hour = int(sunset_t.split(':')[0])
          sunset_min = int(sunset_t.split(':')[1])

          def is_night(dt):
              return dt.hour > sunset_hour or (dt.hour == sunset_hour and dt.minute >= sunset_min) or dt.hour < sunrise_hour
          night_clear = {0,1,2}
          night_overcast = {3,45,48}

          # --- Current conditions from Stanford ---
          cur_temp = stanford.get('temp_f', 0)
          cur_hum = stanford.get('humidity', 50)
          cur_wind = stanford.get('wind_mph', 0)
          cur_wc = stanford.get('weather_code', 0)
          cur_feels = cur_temp  # Stanford doesn't compute apparent temp

          # --- AQI from Stanford ---
          us_aqi = stanford.get('aqi') or 0

          # --- Atlas forecast data ---
          atlas_daily = atlas.get('daily', [])
          atlas_hourly = atlas.get('hourly_6h', [])
          init_time = atlas.get('init_time', '')
          init_dt = None
          if init_time:
              try:
                  init_dt = datetime.fromisoformat(init_time)
              except: pass

          # --- NDVI ---
          ndvi_val = canopy.get('ndvi', 0)
          ndvi_prev = canopy.get('prev_ndvi', 0)
          ndvi_date = canopy.get('date', '')
          delta = ndvi_val - ndvi_prev
          if delta > 0.02: trend = 'â†‘'
          elif delta < -0.02: trend = 'â†“'
          else: trend = 'â†’'
          ndvi_pct = round(ndvi_val * 100)
          ndvi_num = f'{ndvi_val:.2f}'
          if ndvi_val >= 0.9: leaf = 'ğŸŒ´'
          elif ndvi_val >= 0.75: leaf = 'ğŸŒ²'
          elif ndvi_val >= 0.6: leaf = 'ğŸŒ³'
          elif ndvi_val >= 0.45: leaf = 'ğŸŒ¿'
          elif ndvi_val >= 0.3: leaf = 'ğŸŒ±'
          elif ndvi_val >= 0.15: leaf = 'ğŸ‚'
          else: leaf = 'ğŸœ'
          ndvi_str = f'{leaf}{ndvi_pct}' if ndvi_val > 0 else 'ğŸ‚--'

          # --- Line 1: Current hour (Stanford) + next hours (Atlas 6h) + NDVI ---
          parts = []
          # Current hour from Stanford
          hr_now = now.strftime('%I%p').lstrip('0').rstrip('M').lower()
          if is_night(now) and cur_wc in night_clear:
              ic = moon_icon(now)
          elif is_night(now) and cur_wc in night_overcast:
              ic = 'ğŸŒ«'
          else:
              ic = icons.get(cur_wc, 'â˜€ï¸')
          parts.append(f'{hr_now}{ic}')

          # Next Atlas 6h steps (skip past ones)
          if init_dt and atlas_hourly:
              for step in atlas_hourly:
                  step_dt = init_dt + timedelta(hours=step['lead_hours'])
                  if step_dt <= now:
                      continue
                  if len(parts) >= 7:
                      break
                  wc = step.get('weather_code', 2)
                  hr_s = step_dt.strftime('%I%p').lstrip('0').rstrip('M').lower()

                  # Check sunset/sunrise proximity
                  sunset_dt = datetime.strptime(sunset_str.split('T')[0] + 'T' + sunset_t, '%Y-%m-%dT%H:%M')
                  diff_sun = abs((step_dt - sunset_dt).total_seconds()) / 3600
                  if diff_sun < 1:
                      ev_hr = sunset_dt.strftime('%I:%M%p').lstrip('0').rstrip('M').lower()
                      if wc in night_clear:
                          ic = moon_icon(step_dt)
                      else:
                          ic = 'ğŸŒ«'
                      parts.append(f'{ev_hr}{ic}')
                  elif is_night(step_dt) and wc in night_clear:
                      ic = moon_icon(step_dt)
                      parts.append(f'{hr_s}{ic}')
                  elif is_night(step_dt) and wc in night_overcast:
                      parts.append(f'{hr_s}ğŸŒ«')
                  else:
                      ic = icons.get(wc, 'â›…ï¸')
                      parts.append(f'{hr_s}{ic}')

          hourly_line = ' '.join(parts[:7])
          print(f'{hourly_line}  {ndvi_str}')

          # --- Lines 2-5: Daily forecast from Atlas ---
          today_str = now.strftime('%Y-%m-%d')
          prev_hi = None
          shown_moon = set()
          day_count = 0
          for day in atlas_daily:
              if day['date'] <= today_str:
                  prev_hi = round(day.get('temp_high_f', 65))
                  continue
              if day_count >= 4:
                  break
              dt = datetime.strptime(day['date'], '%Y-%m-%d')
              day_name = days_names[dt.weekday()]
              hi_t = round(day.get('temp_high_f', 65))
              wc = day.get('weather_code', 2)
              cloud = day.get('cloud_avg_pct', 50)
              ic = icons.get(wc, 'â›…ï¸')

              delta_t = hi_t - prev_hi if prev_hi is not None else 0
              moon = moon_phase(day['date'])
              alert = ''
              if moon and moon not in shown_moon:
                  alert = ' ' + moon
                  shown_moon.add(moon)
              elif delta_t <= -5: alert = ' ğŸ”»'

              # Show weather icon + cloud %
              print(f'{day_name} {hi_t:>2}Â° {ic} â˜{round(cloud)}%{alert}')
              prev_hi = hi_t
              day_count += 1

          # Fill remaining days if Atlas doesn't have enough
          while day_count < 4:
              print(f'--- --Â° --')
              day_count += 1

          # --- Below fold ---
          print()

          # Comfort index from Stanford current conditions
          comfort = 100.0
          if cur_feels < 62: comfort -= min(30, (62 - cur_feels) * 1.5)
          elif cur_feels > 75: comfort -= min(30, (cur_feels - 75) * 2)
          if cur_hum < 35: comfort -= min(12, (35 - cur_hum) * 0.6)
          elif cur_hum > 60: comfort -= min(15, (cur_hum - 60) * 0.5)
          if cur_wind > 12: comfort -= min(12, (cur_wind - 12) * 1.2)
          elif cur_wind < 2: comfort -= 3
          comfort -= min(25, us_aqi * 0.2)
          if ndvi_val > 0: comfort += min(5, ndvi_val * 8)
          comfort = max(0, min(100, round(comfort)))
          if comfort >= 80: c_dot = 'ğŸŸ¢'
          elif comfort >= 60: c_dot = 'ğŸŸ¡'
          elif comfort >= 40: c_dot = 'ğŸŸ '
          else: c_dot = 'ğŸ”´'

          t_pen = min(30, (62-cur_feels)*1.5) if cur_feels<62 else min(30,(cur_feels-75)*2) if cur_feels>75 else 0
          h_pen = min(12,(35-cur_hum)*0.6) if cur_hum<35 else min(15,(cur_hum-60)*0.5) if cur_hum>60 else 0
          w_pen = min(12,(cur_wind-12)*1.2) if cur_wind>12 else 3 if cur_wind<2 else 0
          a_pen = min(25, us_aqi*0.2)
          n_bon = min(5, ndvi_val*8) if ndvi_val>0 else 0

          print(f'ğŸƒ Comfort {comfort}/100 {c_dot}')
          print(f'  temp {-round(t_pen)} hum {-round(h_pen)} wind {-round(w_pen)} aqi {-round(a_pen)} ndvi +{round(n_bon)}')
          src = 'Sentinel-2 10m' if ndvi_val > 0 else 'MODIS'
          ndvi_chg = f'{delta:+.2f}' if ndvi_val > 0 else '--'
          print(f'ğŸ›° NDVI {ndvi_num} ({ndvi_chg}) {trend} [{src}] {ndvi_date}')
          print(f'ğŸ’¨ AQI {round(us_aqi)} [Stanford]')
          sun_lbl = moon_icon(now) if is_night(now) else 'â˜€'
          print(f'ğŸŒ¡ Feels {round(cur_feels)}Â° | {sun_lbl} {sunrise_t}-{sunset_t}')
          print(f'ğŸ’§ Hum {round(cur_hum)}% | Wind {round(cur_wind)} mph')
          stale = atlas.get('stale', True)
          model = atlas.get('model', '?')
          age = atlas.get('age_hours')
          age_str = f'{age:.0f}h ago' if age else '?'
          print(f'ğŸ¤– {model} | {age_str}{\" âš  STALE\" if stale else \"\"}')
          " "$E2_DATA" "$NDVI_DATA" "$STANFORD_DATA")

          # Generate cloud cover GeoJSON map (uses Atlas data via E2_DATA env)
          GEOJSON=$(python3 .github/scripts/cloud_cover.py 2>/dev/null || echo '{"type":"FeatureCollection","features":[]}')

          # Update gist
          for i in 1 2 3; do
            gh gist edit "$GIST_ID" -f "aircloudy" - <<< "$WEATHER" && break
            echo "Retry $i..." && sleep 5
          done

          for i in 1 2 3; do
            echo "$GEOJSON" | gh gist edit "$GIST_ID" -f "paloalto.geojson" - && break
            echo "Retry geojson $i..." && sleep 5
          done
