name: Weather Box

on:
  schedule:
    - cron: "0 */12 * * *" # Every 12 hours
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch weather and update gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
          TZ: America/Los_Angeles
        run: |
          LAT=37.4529
          LON=-122.1817

          DATA=$(curl -sf "https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&hourly=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=America/Los_Angeles&forecast_days=5")

          WEATHER=$(python3 -c "
          import json, sys
          from datetime import datetime

          icons = {
            0:'â˜€',1:'ðŸŒ¤',2:'â›…',3:'â˜',45:'ðŸŒ«',48:'ðŸŒ«',51:'ðŸŒ¦',53:'ðŸŒ¦',55:'ðŸŒ¦',
            61:'ðŸŒ§',63:'ðŸŒ§',65:'ðŸŒ§',71:'ðŸŒ¨',73:'ðŸŒ¨',75:'ðŸŒ¨',80:'ðŸŒ§',81:'ðŸŒ§',82:'ðŸŒ§',
            95:'â›ˆ',96:'â›ˆ',99:'â›ˆ'
          }
          days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']

          data = json.load(sys.stdin)
          d = data['daily']
          h = data['hourly']

          # TZ env is set to America/Los_Angeles so now() returns Pacific time
          # Open-Meteo hourly times are also in America/Los_Angeles
          now = datetime.now()

          hour_idx = None
          for i, t in enumerate(h['time']):
              dt = datetime.strptime(t, '%Y-%m-%dT%H:%M')
              if dt >= now:
                  hour_idx = i
                  break
          if hour_idx is None:
              hour_idx = len(h['time']) - 6

          parts = []
          for i in range(hour_idx, min(hour_idx + 6, len(h['time']))):
              dt = datetime.strptime(h['time'][i], '%Y-%m-%dT%H:%M')
              hr = dt.strftime('%I%p').lstrip('0').lower()
              temp = round(h['temperature_2m'][i])
              code = h['weather_code'][i]
              ic = icons.get(code, '?')
              parts.append(f'{hr} {ic} {temp}Â°')

          hourly_line = '  '.join(parts)

          def rain_bar(pct):
              filled = round(pct / 20)
              return 'â–“' * filled + 'â–‘' * (5 - filled)

          day_lines = []
          for i in range(1, 5):
              dt = datetime.strptime(d['time'][i], '%Y-%m-%d')
              day = days[dt.weekday()]
              code = d['weather_code'][i]
              ic = icons.get(code, '?')
              hi = round(d['temperature_2m_max'][i])
              lo = round(d['temperature_2m_min'][i])
              rain = d['precipitation_probability_max'][i] or 0
              bar = rain_bar(rain)
              day_lines.append(f'{day}  {ic} {hi}Â°/{lo}Â°  {bar} {rain:>2}%')

          print(hourly_line)
          print('â”€' * 48)
          for l in day_lines:
              print(l)
          " <<< "$DATA")

          gh gist edit "$GIST_ID" -f "weather.txt" - <<< "$WEATHER"
