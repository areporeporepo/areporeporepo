name: Weather Box

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Earth Engine API
        run: pip install earthengine-api

      - name: Fetch weather and update gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GEE_SERVICE_ACCOUNT_KEY: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
          TZ: America/Los_Angeles
          LAT: "37.44783"
          LON: "-122.13604"
        run: |
          WEATHER_DATA=$(curl -sf "https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&hourly=temperature_2m,weather_code,relative_humidity_2m,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America/Los_Angeles&forecast_days=5")

          AQI_DATA=$(curl -sf "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=pm2_5,pm10,us_aqi&timezone=America/Los_Angeles&forecast_days=1")

          # Sentinel-2 NDVI via Google Earth Engine (10m resolution)
          NDVI_DATA=$(python3 .github/scripts/canopy.py 2>/dev/null || echo '{"ndvi":0,"prev_ndvi":0,"date":""}')

          WEATHER=$(python3 -c "
          import json, sys
          from datetime import datetime

          weather = json.loads(sys.argv[1])
          aq = json.loads(sys.argv[2])
          canopy = json.loads(sys.argv[3])

          icons = {
            0:'‚òÄ',1:'üå§',2:'‚õÖ',3:'‚òÅ',45:'üå´',48:'üå´',51:'üå¶',53:'üå¶',55:'üå¶',
            61:'üåß',63:'üåß',65:'üåß',71:'üå®',73:'üå®',75:'üå®',80:'üåß',81:'üåß',82:'üåß',
            95:'‚õà',96:'‚õà',99:'‚õà'
          }
          narrow = {'‚òÄ','‚òÅ','‚õÖ','‚õà'}
          def pad(ic):
              return ic + ' ' if ic in narrow else ic
          days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']

          d = weather['daily']
          h = weather['hourly']

          now = datetime.now()
          hour_idx = 0
          for i, t in enumerate(h['time']):
              if datetime.strptime(t, '%Y-%m-%dT%H:%M') >= now:
                  hour_idx = i
                  break

          # --- Canopy from Google Earth Engine Sentinel-2 ---
          ndvi_val = canopy.get('ndvi', 0)
          ndvi_prev = canopy.get('prev_ndvi', 0)
          ndvi_date = canopy.get('date', '')

          if ndvi_val >= 0.6: canopy_dot = 'üü¢'
          elif ndvi_val >= 0.4: canopy_dot = 'üü°'
          elif ndvi_val >= 0.2: canopy_dot = 'üü†'
          else: canopy_dot = 'üî¥'

          delta = ndvi_val - ndvi_prev
          if delta > 0.02: trend = '‚Üë'
          elif delta < -0.02: trend = '‚Üì'
          else: trend = '‚Üí'

          ndvi_num = f'{ndvi_val:.2f}'
          ndvi_str = f'üå≥{canopy_dot}{ndvi_num}{trend}' if ndvi_val > 0 else 'üå≥--'

          # --- AQI ---
          aq_h = aq.get('hourly', {})
          aq_times = aq_h.get('time', [])
          aq_idx = 0
          for i, t in enumerate(aq_times):
              if datetime.strptime(t, '%Y-%m-%dT%H:%M') >= now:
                  aq_idx = max(0, i - 1)
                  break
          def safe(arr, idx):
              return (arr[min(idx, len(arr)-1)] if arr else 0) or 0
          us_aqi = safe(aq_h.get('us_aqi',[]), aq_idx)
          pm25 = safe(aq_h.get('pm2_5',[]), aq_idx)
          humidity = safe(h.get('relative_humidity_2m',[]), hour_idx)
          wind = safe(h.get('wind_speed_10m',[]), hour_idx)

          # Line 1: hourly forecast + canopy
          parts = []
          for i in range(hour_idx, min(hour_idx + 8, len(h['time']))):
              dt = datetime.strptime(h['time'][i], '%Y-%m-%dT%H:%M')
              hr = dt.strftime('%I%p').lstrip('0').rstrip('M').lower()
              ic = icons.get(h['weather_code'][i], '?')
              parts.append(f'{hr}{ic}')
          hourly_line = ' '.join(parts)
          print(f'{hourly_line}  {ndvi_str}')

          # Lines 2-5: daily with spaced icons
          def day_icons(day_str):
              sample = [6, 9, 12, 15, 18, 21]
              r = []
              for j, t in enumerate(h['time']):
                  dt = datetime.strptime(t, '%Y-%m-%dT%H:%M')
                  if dt.strftime('%Y-%m-%d') == day_str and dt.hour in sample:
                      r.append(pad(icons.get(h['weather_code'][j], '‚òÅ')))
              return ' '.join(r)

          prev_hi = round(d['temperature_2m_max'][0])
          for i in range(1, 5):
              dt = datetime.strptime(d['time'][i], '%Y-%m-%d')
              day = days[dt.weekday()]
              hi_t = round(d['temperature_2m_max'][i])
              hourly = day_icons(d['time'][i])
              rain = d['precipitation_probability_max'][i] or 0
              delta_t = hi_t - prev_hi
              alert = ''
              if delta_t <= -5: alert = ' üîª'
              elif rain >= 50: alert = ' üåä'
              print(f'{day} {hi_t:>2}¬∞ {hourly}{alert}')
              prev_hi = hi_t

          # Lines below fold (hidden from pinned preview)
          print()
          src = 'Sentinel-2 10m' if ndvi_val > 0 else 'unavailable'
          print(f'üõ∞ NDVI {ndvi_num} ({ndvi_date}) {trend} [{src}]')
          print(f'AQI {us_aqi} | PM2.5 {round(pm25)} | Wind {round(wind)} | Hum {round(humidity)}%')
          " "$WEATHER_DATA" "$AQI_DATA" "$NDVI_DATA")

          for i in 1 2 3; do
            gh gist edit "$GIST_ID" -f "aircloudy" - <<< "$WEATHER" && break
            echo "Retry $i..." && sleep 5
          done
