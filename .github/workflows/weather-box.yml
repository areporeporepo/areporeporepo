name: Weather Box

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch weather and update gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
          TZ: America/Los_Angeles
        run: |
          LAT=37.4529
          LON=-122.1817

          WEATHER_DATA=$(curl -sf "https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&hourly=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=America/Los_Angeles&forecast_days=5")

          AQI_DATA=$(curl -sf "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&current=us_aqi&timezone=America/Los_Angeles")

          WEATHER=$(python3 -c "
          import json, sys
          from datetime import datetime

          weather = json.loads(sys.argv[1])
          aqi = json.loads(sys.argv[2])

          icons = {
            0:'â˜€',1:'ğŸŒ¤',2:'â›…',3:'â˜',45:'ğŸŒ«',48:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ¦',55:'ğŸŒ¦',
            61:'ğŸŒ§',63:'ğŸŒ§',65:'ğŸŒ§',71:'ğŸŒ¨',73:'ğŸŒ¨',75:'ğŸŒ¨',80:'ğŸŒ§',81:'ğŸŒ§',82:'ğŸŒ§',
            95:'â›ˆ',96:'â›ˆ',99:'â›ˆ'
          }
          # â˜€ â˜ â›… â›ˆ render as 1-cell wide in monospace; pad to match 2-cell emoji
          narrow = {'â˜€','â˜','â›…','â›ˆ'}
          def ic_pad(ic):
              return ic + ' ' if ic in narrow else ic
          days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']

          d = weather['daily']
          h = weather['hourly']

          # AQI label
          aqi_val = aqi.get('current', {}).get('us_aqi', None)
          if aqi_val is not None:
              if aqi_val <= 50: aqi_label = 'ğŸŸ¢'
              elif aqi_val <= 100: aqi_label = 'ğŸŸ¡'
              elif aqi_val <= 150: aqi_label = 'ğŸŸ '
              elif aqi_val <= 200: aqi_label = 'ğŸ”´'
              else: aqi_label = 'ğŸŸ£'
          else:
              aqi_val = 'â€“'
              aqi_label = 'âšª'

          # Hourly: icons only, fit ~8 hours + AQI in ~40 char width
          now = datetime.now()
          hour_idx = 0
          for i, t in enumerate(h['time']):
              if datetime.strptime(t, '%Y-%m-%dT%H:%M') >= now:
                  hour_idx = i
                  break

          parts = []
          for i in range(hour_idx, min(hour_idx + 8, len(h['time']))):
              dt = datetime.strptime(h['time'][i], '%Y-%m-%dT%H:%M')
              hr = dt.strftime('%I%p').lstrip('0').rstrip('M').lower()
              ic = icons.get(h['weather_code'][i], '?')
              parts.append(f'{hr}{ic}')
          hourly_line = ' '.join(parts)

          # Get hourly icons for a given day (every 3h: 6a,9a,12p,3p,6p,9p)
          def day_hours(day_str):
              sample_hours = [6, 9, 12, 15, 18, 21]
              result = []
              for j, t in enumerate(h['time']):
                  dt = datetime.strptime(t, '%Y-%m-%dT%H:%M')
                  if dt.strftime('%Y-%m-%d') == day_str and dt.hour in sample_hours:
                      result.append(icons.get(h['weather_code'][j], '?'))
              return ''.join(result)

          # Daily: next 4 days with hourly progression + alerts
          day_lines = []
          prev_hi = round(d['temperature_2m_max'][0])
          for i in range(1, 5):
              dt = datetime.strptime(d['time'][i], '%Y-%m-%d')
              day = days[dt.weekday()]
              hi = round(d['temperature_2m_max'][i])
              hourly = day_hours(d['time'][i])
              # Alert: temp drop >=5Â° or rain >50%
              rain = d['precipitation_probability_max'][i] or 0
              delta = hi - prev_hi
              alert = ''
              if delta <= -5: alert = ' ğŸ”»'
              elif rain >= 50: alert = ' ğŸŒŠ'
              day_lines.append(f'{day} {hi:>2}Â° {hourly}{alert}')
              prev_hi = hi

          print(f'{hourly_line}  {aqi_label}{aqi_val}')
          for l in day_lines:
              print(l)
          " "$WEATHER_DATA" "$AQI_DATA")

          gh gist edit "$GIST_ID" -f "aircloudy" - <<< "$WEATHER"
